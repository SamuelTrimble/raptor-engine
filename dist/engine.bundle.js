!function(t){var i={};function e(s){if(i[s])return i[s].exports;var n=i[s]={i:s,l:!1,exports:{}};return t[s].call(n.exports,n,n.exports,e),n.l=!0,n.exports}e.m=t,e.c=i,e.d=function(t,i,s){e.o(t,i)||Object.defineProperty(t,i,{enumerable:!0,get:s})},e.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},e.t=function(t,i){if(1&i&&(t=e(t)),8&i)return t;if(4&i&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(e.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&i&&"string"!=typeof t)for(var n in t)e.d(s,n,function(i){return t[i]}.bind(null,n));return s},e.n=function(t){var i=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(i,"a",i),i},e.o=function(t,i){return Object.prototype.hasOwnProperty.call(t,i)},e.p="",e(e.s=0)}([function(t,i,e){"use strict";e.r(i);var s=class{constructor(){}Linear(t,i,e,s){return e*t/s+i}EaseInOutQuad(t,i,e,s){return(t/=s/2)<1?e/2*t*t+i:-e/2*(--t*(t-2)-1)+i}},n=class{constructor(t){if(!t)throw new Error("LoadingSpinner must be initialized with a valid 'canvas' element!");this._canvas=t,this._context=this._canvas.getContext("2d"),this._isRunning=!1,this._intervalTimer=null,this._filterStrength=20,this._frameTime=0,this._lastLoop=new Date,this._thisLoop=new Date,this._curFPS="N/A"}get running(){return this._isRunning}Start(){this._isRunning=!0,this._intervalTimer=setInterval(()=>{this._curFPS=(1e3/this._frameTime).toFixed(2)},1e3)}Stop(){this._isRunning=!1,clearInterval(this._intervalTimer),this._intervalTimer=null}Tick(){this._thisLoop=new Date;let t=this._thisLoop-this._lastLoop;this._frameTime+=(t-this._frameTime)/this._filterStrength,this._lastLoop=this._thisLoop}Render(){this._context.font="18px sans-serif",this._context.fillStyle="#000000",this._context.fillText("FPS: "+this._curFPS,7,21),this._context.fillStyle="#FFFFFF",this._context.fillText("FPS: "+this._curFPS,5,19)}},a=class{constructor(t=null,i={}){if(!t)throw new Error("LoadingSpinner must be initialized with a valid 'canvas' element!");this._canvas=t,this._context=this._canvas.getContext("2d"),this._spinCanvas=document.createElement("canvas"),this._spinContext=this._spinCanvas.getContext("2d"),this._spinCanvas.width=300,this._spinCanvas.height=300,this._state={opacity:0,fadingIn:!1,fadingOut:!1,curFrame:0},this._PI180=Math.PI/180,this._options={fillColor:"#000000",borderColor:"#F0F0F0",easingFunc:null},this._options={...this._options,...i}}set show(t){t&&0===this._state.opacity?this._state.fadingIn=!0:t||100!==this._state.opacity||(this._state.fadingOut=!0)}Render(){if(this._state.fadingIn&&(this._state.opacity+=5,this._state.opacity>=100&&(this._state.opacity=100,this._state.fadingIn=!1)),this._state.fadingOut&&(this._state.opacity-=5,this._state.opacity<=0&&(this._state.opacity=0,this._state.fadingOut=!1)),this._state.opacity>0){this._state.curFrame++,150===this._state.curFrame&&(this._state.curFrame=0),this._spinContext.setTransform(1,0,0,1,0,0),this._spinContext.clearRect(0,0,300,300),this._spinContext.globalAlpha=this._state.opacity/100;let t=45;(t=null!==this._options.easingFunc?this._options.easingFunc(this._state.curFrame,45,720,150):720*this._state.curFrame/150+45)>=360&&(t-=360),this._spinContext.translate(150,150),this._spinContext.rotate(this._PI180*t),this._spinContext.translate(-150,-150),this._spinContext.fillStyle=this._options.fillColor,this._spinContext.strokeStyle=this._options.borderColor,this._spinContext.lineWidth=2,this._spinContext.beginPath(),this._spinContext.moveTo(100,100),this._spinContext.lineTo(200,100),this._spinContext.lineTo(200,200),this._spinContext.lineTo(100,200),this._spinContext.closePath(),this._spinContext.fill(),this._spinContext.stroke();let i=(this._canvas.width-300)/2,e=(this._canvas.height-150)/2;this._context.drawImage(this._spinCanvas,i,e,300,150)}}},o=class{constructor(t={}){this._options={position:{x:0,y:0},pixelBounds:{x:0,y:0,w:0,h:0},state:{focused:!1,occupied:!1},texture:null},this._options={...this._options,...t}}get x(){return this._options.position.x}get y(){return this._options.position.y}get bounds(){return this._options.pixelBounds}get focused(){return this._options.state.focused}set focused(t){this._options.state.focused=t}get occupied(){return this._options.state.occupied}set occupied(t){this._options.state.occupied=t}get texture(){return this._options.texture}};const l={INFO:0,WARNING:1,ERROR:2},h={NONE:0,FADE:1,MOVE:2,ZOOM:3};window.STL=window.STL||{},window.STL.DEBUGLEVEL=window.STL.DEBUGLEVEL||l,window.STL.RaptorEngine=window.STL.RaptorEngine||class{constructor(t=null,i={}){if(this.MINZOOM=1,this.MAXZOOM=5,this.ZOOMSCALEINCREMENT=2,this._options={debugging:!1,debuggingLevel:l.WARNING,mapDataFile:"",mapBackgroundColor:"#000000",tileDefaultColor:"#F0F0F0"},this._options={...this._options,...i},this._map={data:null,textureData:null,isBuilding:!1,tileSize:0,tileQuarterSize:0,tileHalfSize:0,tileDoubleSize:0,tilesW:0,tilesH:0,offsetX:0,pixelsW:0,pixelsH:0,tiles:[]},this._state={loading:!1,running:!1,curPosition:{x:0,y:0},focusedTile:null,zoom:3,opacity:0,sightRange:3,transitionQueue:[]},!t)throw this._Log(l.ERROR,"No 'canvas' specified!"),new Error("RaptorEngine must be initialized with a valid 'canvas' element!");""===this._options.mapDataFile&&this._Log(l.WARNING,"No 'mapDataFile' specified in the initialization options!"),this._canvas=t,this._context=this._canvas.getContext("2d"),this._fullCanvas=document.createElement("canvas"),this._fullContext=this._fullCanvas.getContext("2d"),this._canvasSize={},this._canvasSize.w=this._canvas.width=this._canvas.offsetWidth,this._canvasSize.h=this._canvas.height=this._canvas.offsetHeight,this._easing=new s,this._timer=null,this._options.debugging&&(this._timer=new n(t)),this._loadingSpinner=new a(t,{fillColor:this._options.mapBackgroundColor,borderColor:this._options.tileDefaultColor,easingFunc:this._easing.EaseInOutQuad}),this._Log(l.INFO,"Engine Initialized"),this._BuildMapLayout()}get options(){return this._options}set options(t){let i=!1,e=this._options;this._options={...this._options,...t},this._options.mapDataFile!==e.mapDataFile&&(i=!0),i&&this._BuildMapLayout()}_Log(t,i){if(this._options.debugging&&this._options.debuggingLevel<=t)switch(t){case l.INFO:console.log("%cINFO: %c"+i,"font-weight:800;","font-weight:400;");break;case l.WARNING:console.log("%cWARNING: %c"+i,"font-weight:800;color:#A17727;","font-weight:400;");break;case l.ERROR:console.log("%cERROR: %c"+i,"font-weight:800;color:#A12727;","font-weight:400;")}}_LoadImage(t){return new Promise((i,e)=>{let s=new Image;s.onload=(()=>{i(s)}),s.onerror=(()=>{this._Log(l.ERROR,"Retrieving image at: '"+t+"' failed!"),i(null)}),s.src=t})}async _GetMapData(t){try{let i=await fetch(t,{method:"GET",headers:{"Content-type":"application/json"}});return await i.json()}catch(t){return this._Log(l.ERROR,"Retrieving map data failed!"),this._Log(l.ERROR,t),null}}async _GetTextures(t){try{let i=[];for(let e=0;e<t.length;e++)i.push(this._LoadImage(t[e].path));let e=await Promise.all(i),s={};s.sourceImages=e,s.textures={};for(let i=0;i<t.length;i++)for(let e=0;e<t[i].tiles.length;e++){let n=t[i].tiles[e];s.textures[n.name]={img:i,x:n.x,y:n.y,w:t[i].size.w,h:t[i].size.h,z:t[i].size.z,blocking:n.blocking}}return s}catch(t){return this._Log(l.ERROR,"Retrieving map textures failed!"),this._Log(l.ERROR,t),null}}async _BuildMapLayout(){if(this._Log(l.INFO,"Building map layout..."),this._state.loading=!0,1!==this._state.opacity)if(this._map.isBuilding=!0,this._map.data=await this._GetMapData(this._options.mapDataFile),null!==this._map.data)if(this._map.textureData=await this._GetTextures(this._map.data.textures),null!==this._map.textureData){this._state.curPosition.x=this._map.data.start.x,this._state.curPosition.y=this._map.data.start.y,this._state.zoom=this._map.data.start.zoom,this._state.sightRange=this._map.data.start.sightRange,this._map.tileSize=this._map.data.tileSize,this._map.tileQuarterSize=this._map.tileSize/4,this._map.tileHalfSize=this._map.tileSize/2,this._map.tileDoubleSize=2*this._map.tileSize,this._map.tilesW=this._map.data.tileMap[0].length,this._map.tilesH=this._map.data.tileMap.length,this._map.offsetX=this._map.tilesW*this._map.tileSize,this._map.pixelsW=this._map.tilesW*this._map.tileSize+this._map.tileDoubleSize+this._map.offsetX,this._map.pixelsH=this._map.tilesH*this._map.tileSize+this._map.tileSize,this._state.transitionQueue.length=0,this._state.opacity=0,this._QueueTransition(h.FADE,0,1,60,60,this._easing.Linear,()=>{this._state.loading=!1});for(let t=0;t<this._map.tiles.length;t++)this._map.tiles[t].length=0;this._map.tiles.length=0;for(let t=0;t<this._map.tilesH;t++){this._map.tiles.push([]);for(let i=0;i<this._map.tilesW;i++)if(1===this._map.data.tileMap[t][i]){let e=this._GridToPixels(i,t),s=""!==this._map.data.textureMap[t][i]?this._map.textureData.textures[this._map.data.textureMap[t][i]]:null,n=new o({position:{x:i,y:t},pixelBounds:{x:e.x,y:e.y,w:this._map.tileDoubleSize,h:this._map.tileSize},state:{focused:i===this._state.curPosition.x&&t===this._state.curPosition.y,occupied:null!==s&&s.blocking},texture:s});n.focused&&(this._state.focusedTile=n),this._map.tiles[t].push(n)}else this._map.tiles[t].push(null)}this._fullCanvas.width=this._map.pixelsW,this._fullCanvas.height=this._map.pixelsH,this._fullContext.setTransform(1,0,0,1,0,0),this._fullContext.fillStyle=this._options.mapBackgroundColor,this._fullContext.fillRect(0,0,this._map.pixelsW,this._map.pixelsH),this._fullContext.fillStyle=this._options.tileDefaultColor,this._fullContext.strokeStyle=this._options.mapBackgroundColor,this._fullContext.lineWidth=2;for(let t=0;t<this._map.tilesH;t++)for(let i=0;i<this._map.tilesW;i++){let e=this._map.tiles[t][i];if(null!==e){let t=e.bounds.x,i=e.bounds.y,s=e.bounds.w,n=e.bounds.h,a=e.texture;if(null!==a){let e=this._map.textureData.sourceImages[a.img],o=a.x,l=a.y,h=a.w,r=a.h,_=t,u=s,p=s/a.w*a.h,c=i+n+a.z-p;this._fullContext.drawImage(e,o,l,h,r,_,c,u,p)}else this._fullContext.beginPath(),this._fullContext.moveTo(t,i+this._map.tileHalfSize),this._fullContext.lineTo(t+this._map.tileSize,i),this._fullContext.lineTo(t+this._map.tileDoubleSize,i+this._map.tileHalfSize),this._fullContext.lineTo(t+this._map.tileSize,i+this._map.tileSize),this._fullContext.closePath(),this._fullContext.fill(),this._fullContext.stroke()}}this._map.isBuilding=!1,this._Log(l.INFO,"Finished building map layout.")}else this._map.isBuilding=!1;else this._map.isBuilding=!1;else this._QueueTransition(h.FADE,1,0,0,60,this._easing.Linear,this._BuildMapLayout.bind(this))}_GridToPixels(t,i){return{x:t*this._map.tileSize-i*this._map.tileSize+this._map.offsetX,y:t*this._map.tileHalfSize+i*this._map.tileHalfSize}}_TileAt(t,i){return i<0?null:i>=this._map.tiles.length?null:t<0?null:t>=this._map.tiles[i].length?null:this._map.tiles[i][t]}_TransitionExistsInQueue(t){for(let i=0;i<this._state.transitionQueue.length;i++)if(this._state.transitionQueue[i].type===t)return!0;return!1}_QueueTransition(t,i,e,s,n,a,o){let l={type:t,start:i,end:e,delay:s,duration:n,time:0,easingFunc:a,callbackFunc:o};this._state.transitionQueue.push(l)}_RenderFrame(){if(this._context.fillStyle=this._options.mapBackgroundColor,this._context.fillRect(0,0,this._canvasSize.w,this._canvasSize.h),!this._map.isBuilding){let t=this._state.focusedTile,i=this._GridToPixels(t.x,t.y),e=.25;for(let t=this._state.zoom;t>this.MINZOOM;t--)e*=this.ZOOMSCALEINCREMENT;let s=this._state.opacity;if(this._state.transitionQueue.length>0){let t=this._state.transitionQueue[0];if(t.delay>0)t.delay--;else{switch(t.time++,t.type){case h.FADE:t.time<t.duration?s=t.easingFunc(t.time,t.start,t.end-t.start,t.duration):(s=t.end,this._state.opacity=t.end);break;case h.MOVE:let n=this._GridToPixels(t.end.x,t.end.y);t.time<t.duration?(i.x=t.easingFunc(t.time,i.x,n.x-i.x,t.duration),i.y=t.easingFunc(t.time,i.y,n.y-i.y,t.duration)):(i=n,this._state.focusedTile.focused=!1,this._state.focusedTile=t.end,this._state.curPosition.x=t.end.x,this._state.curPosition.y=t.end.y);break;case h.ZOOM:let a=.25;for(let i=t.end;i>this.MINZOOM;i--)a*=this.ZOOMSCALEINCREMENT;t.time<t.duration?e=t.easingFunc(t.time,e,a-e,t.duration):(e=a,this._state.zoom=t.end)}t.time===t.duration&&(null!==t.callbackFunc&&t.callbackFunc(),this._state.transitionQueue.shift())}}i.x+=this._map.tileSize,i.y+=this._map.tileHalfSize;let n=i.x-this._canvasSize.w/e/2,a=i.y-this._canvasSize.h/e/2,o=this._canvasSize.w/e,l=this._canvasSize.h/e;this._context.globalAlpha=s,this._context.drawImage(this._fullCanvas,n,a,o,l,0,0,this._canvasSize.w,this._canvasSize.h),this._context.globalAlpha=1}this._loadingSpinner.show=this._map.isBuilding||this._state.loading,this._loadingSpinner.Render(),null!==this._timer&&(this._timer.Tick(),this._timer.Render()),this._state.running&&requestAnimationFrame(this._RenderFrame.bind(this))}get position(){return this._state.curPosition}_Move(t,i){let e=this._state.focusedTile,s=this._TileAt(this._state.curPosition.x+t,this._state.curPosition.y+i);return null!==s&&!s.occupied&&(this._TransitionExistsInQueue(h.MOVE)||this._QueueTransition(h.MOVE,e,s,0,15,this._easing.EaseInOutQuad,null),!0)}MoveRight(){return this._Move(1,0)}MoveDown(){return this._Move(0,1)}MoveLeft(){return this._Move(-1,0)}MoveUp(){return this._Move(0,-1)}get zoom(){return this._state.zoom}_Zoom(t){let i=this._state.zoom+t;return!this._TransitionExistsInQueue(h.ZOOM)&&i<=this.MAXZOOM&&i>=this.MINZOOM&&(this._QueueTransition(h.ZOOM,this._state.zoom,i,0,15,this._easing.Linear,null),!0)}ZoomIn(){return this._Zoom(1)}ZoomOut(){return this._Zoom(-1)}Start(){this._state.running=!0,null!==this._timer&&this._timer.Start(),requestAnimationFrame(this._RenderFrame.bind(this))}Stop(){this._state.running=!1,null!==this._timer&&this._timer.Stop()}}}]);